---
title: "VF Sheep"
author: "Jackie"
date: "2022-11-02"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r lib, include=FALSE}
library(dplyr)
library(tidyverse)
library(readr)
library(lubridate)
library(DT)
library(sp)


library(rgdal)
library(sf)

#install.packages("plotKML")
library(plotKML)
library(knitr)
library(png)

library(readxl)


library(ggmap)
library(maps)
library(mapdata)

library(raster)
library(agricolae)
library(FSA) 
library(agricolae)
library(multcomp)
library(lsmeans)
#library(hms) Add these before I use them?
#library(plyr)

library(readxl)
library(tidyverse)
library(dplyr)
library(FSA) 
library(agricolae)
library(multcomp)
library(multcomp)
library(lsmeans)
library(multcompView)
library(Rmisc)

library(ggplot2)
library(car)
library(DescTools)
```

## Aim of the trial

To implement VF collars on a commercial farm, and ensure the collars are safe and effective.

Evaluate the cue and pulse data and animal movement during the training period and the trail.

## Location of the trial

The trial is located in Lameroo -35.285283, 140.376381.

The paddock boundaries are digitized using google earth pro.

The dashed line is a 10m buffer around the paddock boundaries.


```{r Lameroo paddock bounadries hard fences, echo=FALSE, message=FALSE, warning=FALSE}

include_graphics("W:/VF/Sheep_Lameroo_2022/spatial_boundary/Boundary map for report.png")

```

## Length and dates of the trial

- Start of training period Day 1 17/10/2022 at 11:40
- End of training period   Day 1 17/10/2022 at 13:00

The animals were yarded everyday and during this time collar and health check were performed.
The collars continued to log during this time therefore the data needs to be cropped to reflect the only trial times

- Day 1 17/10/2022 animals were not yarded the animals started the trial at 13:10
- Day 2 18/10/2022 animals yarded in at 9:40 and back in trial paddock at 10:30
- Day 3 19/10/2022 animals yarded in at 9:10 and back in trial paddock at 10:18
- Day 4 20/10/2022 animals yarded in at 8:58 and back in trial paddock at 10:19
- Day 8 21/10/2022 animals yarded in at 11:50 end of the trial






## Animal collar used
 
 
|  deviceName	    | Sheep ID   | Comments	                                                | 
| ----------------| -----------|----------------                                          |
| 1390743       	| 10   	     |  AKA labelled as blank                                   | 
| 1390581	        | 1          |	                                                        |	
| 1390826         |	2          |	before 18/10/2022 I assume at 10:30 when it was yarded  |	
| 1391505         | 2          |	after 18/10/2022 I assume at 10:30 when it was yarded   |	
| 490705          |	3          |	                                                        | 
| 1390577         |	4          |	                                                        | 
| 1390737         |	5          |	                                                        | 
| 1390749         | 6          |	                                                        | 
| 1390456         | 7          |	                                                        | 
| 1390182         | 8          |	                                                        | 
| 1390736         | 9          |	                                                        | 
| 1390189         | water pt   |	                                                        | 
   
Location of the raw data


## Background information on animal collar data from Gallagher

*Contact*

The data scientist is:

Debdeep Guha

Gallagher eShepherd Pty Ltd

1100-1102 Toorak Road, Camberwell, VIC, 3124


EMAIL  Debdeep.Guha@gallagher.com| WEB www.gallagher.com

**Data provided**

Every 10 mins generates a new row of data, but if the animal get a audio or pulse this creates a new entry.

This can be viewed from the timeOfEvent column.

**timeOfEvent**

Note that this timeOfEvent has a date and time stamp which is in GMT.

The *timeOfEvent* will need to be converted to local time.

This is done in R with lubridate package.

**GPS**

The GPS data is a snapshot of the location of the animals in a 10 min window.

Data columns that are supplied:

- *gpsData.lat*	
- *gpsData.lng*


I will use the lat and long column to create a location of the animal in the 10 min window.

The accuracy of this reading can be viewed within this 10 min window.


**Stimuli - cue and audio readings**

The *cumulativeAudioCount* and	*cumulativeShockCount* columns are a running total of how many stimuli the animal has received since the start of the trial, and is re calculated every 10 mins.

It appears that the increments are not reset when a new fence is implement.
Instead its just keeps cumulating.

This poses a problem when the animals are yarded, they are not part of the trial during this time, but the collars and cues continue to log.


**Device details**

The *deviceName* is the name of the collar, more details about the mob is listed above.


There is another columns which has information about the device this is called *deviceUIDHex*.

**Virtual Fence**

There is a column which is called *minDistanceToIZ*, which is the distance of the animal to the VF.

I am not sure if this is the min distance the animal got to the fence in the 10 min window or its the distance calculated from the logged GPS point in the file in the 10 mins window.

If it is the min distance the animal got to and not just the distance from the fence in the 'snap shot' this would be useful.

Column called *fencesID* is the name of the fence.



*"If the values in “fenceID” column as blank, this means there is no active virtual fence for that neckband yet. Therefore, if you are performing some analysis related to virtual fencing, you can ignore those rows with blank fenceIDs."*


**Animal activity**

There are 3 columns that relate to the 

- *resting%*	

- *moving%*

- *grazing%* 



The first 3 should add up to 100% and this is a sum value for the 10 min of time.

For example in the 10 min window the animals has spent 37% of the time resting, 30% moving and 33% grazing.

## Location of raw data.

- "\\FSSA2-ADL\clw-share1\Microlab\VF\Sheep_Lameroo_2022\animal_logs\raw_data\db_trial_csiro_lemaroo_mob_287_vf_boundary_data.csv"
- "\\FSSA2-ADL\clw-share1\Microlab\VF\Sheep_Lameroo_2022\animal_logs\raw_data\db_trial_csiro_lemaroo_mob_287_filtered.csv"


# Data manipulation notes.

## step 1 

- **use step 1 scripts**

  "C:\Users\ouz001\working_from_home_post_Sep2022\VF_Sheep_Lameroo\animal_logs\step1_VF_animal_logs.R"
  
  This is in the GitHub repository too.
  
  https://github.com/JackieOuzman/VF_Sheep_Lameroo

- This does a few things and its a bit messey at time but this is what the script will do:
- Imports in raw data 
- Formats timeOfEvent clm to be GMT
- Creates local time clm, date clm, DOY clm.
- Creates sheep_ID clm using deviceName using table listed above (inputs supplied by Sue)
- Note that sheep 2 has two deviceName so there is a bit of stuffing around here
- Remove any data entries with no GPS logs
- Turn into spatial data and transform to ESPG 28354 (GDA/MGA zone 54)
- Filter out (remove) data before training period and after end of the trial, this is detailed above, 17/10/22 11:40 to 21/10/22 11:50


This data is saved 

\\FSSA2-ADL\clw-share1\Microlab\VF\Sheep_Lameroo_2022\animal_logs\jax_working\animals_GPS_trim_time_step1.csv


```{r step 1 data for plot, message=FALSE, warning=FALSE, include=FALSE}


step1 <- read_csv("W:/VF/Sheep_Lameroo_2022/animal_logs/jax_working/animals_GPS_trim_time_step1.csv")

#turn into spatial data
step1_sf <-   st_as_sf(step1,
           coords = c("X", "Y"),
           crs = 28354,
           agr = "constant")

############################################################################################
############                  bring in boundaries             ##############################
############################################################################################



Lameroo_Vf_area_hard_fence_bound <- st_read("W:/VF/Sheep_Lameroo_2022/spatial_boundary/VF_working/HF_Lameroo_rough_proj.shp")  # this is the hard fences
Lameroo_Vf_area_hard_fence_bound_buff <- st_read("W:/VF/Sheep_Lameroo_2022/spatial_boundary/HF_Lameroo_rough_10_proj.shp")  # this is the 

Lameroo_Vf_area <-                  st_read("W:/VF/Sheep_Lameroo_2022/spatial_boundary/VF_proj.shp")
Lameroo_Vf_area_buffer_10 <-                  st_read("W:/VF/Sheep_Lameroo_2022/spatial_boundary/VF_Buffer10_proj.shp")
water_pt <-  st_read("W:/VF/Sheep_Lameroo_2022/spatial_boundary/water_pts.shp")





Lameroo_Vf_area_hard_fence_bound <-
  st_transform(Lameroo_Vf_area_hard_fence_bound, crs = 28354)

Lameroo_Vf_area_buffer_10 <-
  st_transform(Lameroo_Vf_area_buffer_10, crs = 28354)
Lameroo_Vf_area <-
  st_transform(Lameroo_Vf_area, crs = 28354)
water_pt <-
  st_transform(water_pt, crs = 28354)

Lameroo_Vf_area_hard_fence_bound_buff<-
  st_transform(Lameroo_Vf_area_hard_fence_bound_buff, crs = 28354)




```


```{r step 1  plot, echo=FALSE, message=FALSE, warning=FALSE}

ggplot() +
  geom_sf(data = Lameroo_Vf_area_hard_fence_bound, color = "black", fill = NA) +
  geom_sf(data = Lameroo_Vf_area, color = "black", fill = NA) +
  geom_sf(data = Lameroo_Vf_area_buffer_10, color = "black", fill = NA) +
  geom_sf(data = water_pt ,color ="Blue") +
  geom_sf(data = step1_sf ,alpha = 0.05) +
  facet_wrap(.~ date)+
  theme_bw()+
  theme(legend.position = "none",
        axis.ticks = element_blank(), axis.text.x = element_blank(), axis.text.y = element_blank())+
  labs(title = "All animal logs between 17th at 11:40 and 21st at 11:50",
  subtitle = "log when animals were yarded removed")


```


## step 2

- **use step 2 scripts**

  "C:\Users\ouz001\working_from_home_post_Sep2022\VF_Sheep_Lameroo\animal_logs\step2_converting_cum_value_to_records.R"
  
  This is in the GitHub repository too.
  
  https://github.com/JackieOuzman/VF_Sheep_Lameroo

- This builds on the data frame produced in step 1
- Aim is to recreate the audio and pulse columns that are not cumulative 
- The *cumulativeAudioCount* and	*cumulativeShockCount* columns are a running total of how many stimuli the animal has received since the  
start of the trial, and is re calculated every 10 mins. 
- Since the animals were yarded but the collar continued to log this is a problem.
- Creates a list of animals based on DeviceName and then runs a loop.
- The loop filters the animal log data (created in step 1) based on the DeviceName in list and created a new clm
- The clm is AudioValue and PulseValue using lag function e.g. Audio_values = cumulativeAudioCount - lag(cumulativeAudioCount


This data is saved 

"\\FSSA2-ADL\clw-share1\Microlab\VF\Sheep_Lameroo_2022\animal_logs\jax_working\animal_GPS_data_step1_2.csv"



## step 3

- **use step 3 scripts**

  ""C:\Users\ouz001\working_from_home_post_Sep2022\VF_Sheep_Lameroo\animal_logs\step 3 clipping the aniamls logs to bounadries.R""
  
  This is in the GitHub repository too.
  
  https://github.com/JackieOuzman/VF_Sheep_Lameroo
  
- This builds on the data frame produced in step 1 and 2
- Aim is to clip the data to the hard fence paddock boundaries 
- This seems to be a problem in this trial, the paddock is small and the sheep enjoy camping next to the physical fence.
- The GPS has 5 - 10m accuracy (but I have always thought this was better than this)
  








## Mean audio/pulse ratio 
AIM: Across all animals, and by individual animal (could be interesting to see if they vary as cattle do?). 
Plot training period vs the trial period.

## GPS Plots
AIM: Daily plots are probably sufficient. 
But more frequent plots during the training period.
And there was that instance where they broke through the fence overnight (we think something spooked them), so a more detailed breakdown of that could also be interesting too. 


